<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>  Kosmgco | 加速乐cookie:__jsl_clearnce 破解新进展 </title>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<link href="/theme/css/github-markdown.css" rel="stylesheet"/>
<link href="/theme/css/custom.css" rel="stylesheet"/>
<meta name="baidu-site-verification" content="qfSD7JIuUr"/>
<meta name="description" content="Linux. Python. Coder. Gopher."/>
<meta name="author" content="kosmgco" />

<meta name="viewport" content="width=device-width, initaial-scale=1"/>  </head>
  <body class="markdown-body">
    <style>
      @media (max-width: 550px) {
        .catalog, .content {
          display:none;
        }
      }
    </style>
    <div class="menu">
      <div class="title" style="background: url(https://static.ooops.me/md-upload-1536468495519.png) no-repeat; background-position: center"></div>
      <h3> Kosmgco </h3>
      <h4> Linux. Python. Coder. Gopher. </h4>
      <div class="links-menu" >
        <a href="/" class="menu-link" title="HOME"><img src="/theme/images/home.png" width="40"/></a>
        <a href="/tags.html" class="menu-link" title="TAGS"><img src="/theme/images/tags.png" width="40"/></a>
        <a href="/categories.html" class="menu-link" title="CATEGORIES"><img src="/theme/images/categories.png" width="40"/></a>
        <a href="/pages/blog.html" class="menu-link" title="BLOG"><img src="/theme/images/blog.png" width="40"/></a>
        <a href="/pages/about.html" class="menu-link" title="ABOUT"><img src="/theme/images/about.png" width="40"/></a>
 
      </div>
      <div class="links">
        <a href="http://github.com/kosmgco" target="_blank">
          <img src="/theme/images/github-128.png" style="width:32px;">
        </a>
        <a href="mailto:i@ooops.me" target="_blank">
          <img src="/theme/images/mail-128.png" style="width:32px;">
        </a>
      </div>
      <div class="links">
        <a href="http://xlzd.me" target="_blank">xlzd杂谈</a>
        <a href="http://midday.me" target="_blank">正午的博客</a>
        <a href="http://mqhong.com" target="_blank">梦梦的咸鱼</a>
        <a href="http://bilibili.ooops.me" target="_blank">B站弹幕</a>
      </div>
      <div class="copyright">
        &copy <a href="/">Kosmgco</a>. 2018<br />
        Powered by <a href="https://getpelican.com" target="_blank">Pelican</a>. Theme by <a href="https://github.com/kosmgco/pelican-theme-mdshow" target="_blank">MDShow</a> 
        <br />
        <a href="https://www.miitbeian.gov.cn/" target="_blank">渝ICP备16003403号</a>
      </div>
    </div>
    <div class="catalog">
      <b>2018-01-16</b><a href="/posts/2018/01/16/golang-json-zi-ding-yi-lei-xing-de-xu-lie-hua-yu-fan-xu-lie-hua.html">Golang JSON 自定义类型的序列化与反序列化</a>
      <b>2017-10-22</b><a href="/posts/2017/10/22/pai-xu-cha-ru-pai-xu.html">排序 - 插入排序</a>
      <b>2017-10-20</b><a href="/posts/2017/10/20/pai-xu-xuan-ze-pai-xu.html">排序 - 选择排序</a>
      <b>2017-09-21</b><a href="/posts/2017/09/21/golang-3des-des-aesjia-mi-jie-mi.html">Golang 3DES, DES, AES加密解密</a>
      <b>2017-09-16</b><a href="/posts/2017/09/16/zi-ji-shi-xian-shi-xian-yi-ge-zhan.html">自己实现实现一个栈</a>
      <b>2017-07-30</b><a href="/posts/2017/07/30/mysqlji-zhu-nei-mu-innodbcun-chu-yin-qing-di-yi-zhang.html">《MySQL技术内幕: InnoDB存储引擎》 - 第一章</a>
      <b>2017-07-08</b><a href="/posts/2017/07/08/nginxri-zhi-fen-xi.html">Nginx日志分析</a>
      <b>2017-02-24</b><a href="/posts/2017/02/24/tong-guo-ren-lian-shi-bie-huo-qu-xue-xiao-xue-sheng-de-xing-bie-bi-li.html">通过人脸识别获取学校学生的性别比例</a>
      <b>2016-12-10</b><a href="/posts/2016/12/10/kai-qi-quan-zhan-https.html">开启全站https</a>
      <b>2016-12-04</b><a href="/posts/2016/12/04/say-hello-world-to-docker.html">Say Hello-World! To Docker</a>
      <b>2016-10-25</b><a href="/posts/2016/10/25/ubuntu-gokai-fa-huan-jing-pei-zhi.html">Ubuntu-Go开发环境配置</a>
      <b>2016-07-19</b><a href="/posts/2016/07/19/shi-yong-python-flaskda-jian-qing-bo-ke.html">使用Python-Flask搭建轻博客</a>
      <b>2016-07-10</b><a href="/posts/2016/07/10/appfan-bian-yi.html">app反编译</a>
      <b>2016-07-10</b><a href="/posts/2016/07/10/gitcao-zuo.html">git操作</a>
      <b>2016-04-16</b><a href="/posts/2016/04/16/nginx-virtual-hostxu-ni-ji.html">nginx virtual host虚拟机</a>
      <b>2016-03-25</b><a href="/posts/2016/03/25/shi-xi-zong-jie.html">实习总结</a>
      <b>2016-03-04</b><a href="/posts/2016/03/04/wei-xin-gong-zhong-hao-yi-ji-zhi-neng-liao-tian-ji-qi-ren-de-jie-ru.html">微信公众号以及智能聊天机器人的接入</a>
      <b>2016-02-27</b><a href="/posts/2016/02/27/jia-su-le-cookie__jsl_clearnce-po-jie-xin-jin-zhan.html">加速乐cookie:__jsl_clearnce 破解新进展</a>
      <b>2016-02-23</b><a href="/posts/2016/02/23/fu-li-tie-shi-yong-ubermian-fei-zuo-zhuan-che.html">福利帖 - 使用uber免费坐专车</a>
      <b>2016-02-02</b><a href="/posts/2016/02/02/pycharmandroid-studioyuan-an-zhuang.html">Pycharm,Android-Studio源安装</a>
      <b>2016-01-17</b><a href="/posts/2016/01/17/pythonpa-qu-tu-pian.html">python爬取图片</a>
      <b>2016-01-10</b><a href="/posts/2016/01/10/zheng-fang-jiao-wu-xi-tong-shu-ju-huo-qu.html">正方教务系统数据获取</a>
      <b>2015-12-24</b><a href="/posts/2015/12/24/flask-wen-jian-jie-gou-zu-zhi.html">flask 文件结构组织</a>
      <b>2015-12-21</b><a href="/posts/2015/12/21/mongodb-xiao-dao-chu-shi.html">mongodb 小刀初试</a>
      <b>2015-12-20</b><a href="/posts/2015/12/20/guan-yu-shua-piao.html">关于刷票</a>
      <b>2015-12-18</b><a href="/posts/2015/12/18/python-jsonjie-xi-na-dian-shi.html">python json解析那点事</a>
      <b>2015-12-12</b><a href="/posts/2015/12/12/flask-chu-kui.html">flask 初窥</a>
      <b>2015-12-09</b><a href="/posts/2015/12/09/guan-yu-jia-su-le-de-__jsl_clearancefan-hui-521zhuang-tai-ma-po-jie.html">关于加速乐的__jsl_clearance返回521状态码破解</a>
    </div>
    <div class="content">
  <style>
    @media(max-width: 550px) {
      body {
        height: auto;
      }
      .menu .links, .menu .copyright {
        display:none;
      }
      .menu {
        height: 65%;
      }
      .catalog {
        display:none;
      }
      .content {
        display: block;
      }
      h3 {
        text-align: center;
      }
    }
  </style>
  <h3> 加速乐cookie:__jsl_clearnce 破解新进展 </h3>
    <a href="/tag/nodejs.html" class="link-tags">nodejs</a>
    <a href="/tag/fan-pa-chong.html" class="link-tags">反爬虫</a>
  <hr style="clear:both"/>
  <hr>
<p>之前在博客里面写了一篇关于加速乐__jsl_clearance的cookie的破解教程: <a href="https://blog.ooops.me/%E5%85%B3%E4%BA%8E%E5%8A%A0%E9%80%9F%E4%B9%90%E7%9A%84-jsl-clearance%E8%BF%94%E5%9B%9E521%E7%8A%B6%E6%80%81%E7%A0%81%E7%A0%B4%E8%A7%A3/">关于加速乐的_jsl_clearance返回521状态码破解</a>，但是呢，之前是使用的ghost来先打开一次网页，获取到cookie后将cookie取出再添加的requests的http头里面，这样比较麻烦，也比较的消耗资源，相当于打开了一个浏览器。速度也比较慢，想想对于Python这样本身性能就不太好的语言来说，再开一个浏览器，对于不断追求高效率的我和如此大规模的数据爬取来说相当不合适。</p>
<p>这次的思路是将js引擎放到服务器上，或者说将一个浏览器内核放到服务器上，由服务器计算cookie并返回。</p>
<p>能在服务器上运行js代码的我不知道多不多，但是在网上搜了搜，发现nodejs还是比较适合的，做成服务也比较方便。在w3c上搜到教程，做了个计算cookie的服务。代码接受一个参数cookie的字符串，然后传给decode方法计算返回。
代码如下:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">querystring</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">);</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">){</span>
        <span class="nx">post</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">post</span> <span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
        <span class="nx">ret</span> <span class="o">=</span> <span class="nx">decode</span><span class="p">(</span><span class="nx">post</span><span class="p">[</span><span class="s1">&#39;ck&#39;</span><span class="p">])</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ret</span><span class="p">)</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">ret</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Server running at http://127.0.0.1:3000/&#39;</span><span class="p">)</span>
</pre></div>


<p>在命令行运行:</p>
<div class="highlight"><pre><span></span>node cookie_caculator.js
</pre></div>


<p>由于对nodejs非常不熟悉。。第一次写，没有任何异常处理的代码。</p>
<p>在python代码中，首先获取一次网页的内容。但是因为没有cookie，所以返回的是一段被加密后的js代码，对js处理之后post到服务端运行js，获取cookie后加到http头里面继续请求。</p>
<p>python代码如下:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">req</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span><span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/46.0.2490.80 Safari/537.36&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_cookie</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">__cookies</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://shixin.court.gov.cn&#39;</span><span class="p">)</span>

    <span class="c1"># 对获取到的js字符串进行处理，避免setTimeout(location.href=)在服务器中运行出错</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;script&gt;(.*?)&lt;/script&gt;&#39;</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;setTimeout&#39;</span><span class="p">,</span><span class="s1">&#39;void&#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;document\.cookie=dc;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ck&#39;</span><span class="p">:</span><span class="n">content</span>
    <span class="p">}</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://10.117.29.191:7778&#39;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="n">cookie</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span>

    <span class="n">cookie</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;__jsl_clearance=&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">cookie</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">__cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;__jsl_clearance&#39;</span><span class="p">:</span><span class="n">cookie</span><span class="p">}</span>

<span class="n">get_cookies</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">__cookies</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print req.headers</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">__cookies</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">521</span><span class="p">:</span>
        <span class="n">get_cookie</span><span class="p">()</span>
        <span class="n">get_</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;error </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">return</span>

    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">get_</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>


<p>因为目标网站已经取消了加速乐的服务，换成了云锁，没有cookie了，不方便测试。就不上测试了。</p>
<p>上面的代码中声明了一个全局变量global __cookies,在运行程序的时候，首先会运行get_cookie()函数。得到了cookie后再获取url所指向的资源的源代码。</p>
<p>ps:由于目标网站更换安全服务后，现在已经不限制获取资源了，但是要封ip。。跟程序员的斗争还未停止。。。</p>
    </div>
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?67d2b3355046511d3ad9eef9c65d2a41";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();

    </script>
  </body>
</html>