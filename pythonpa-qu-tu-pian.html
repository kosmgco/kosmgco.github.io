<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> python爬取图片</title>

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Linux. Python. Coder. Gopher.">
    <meta name="author" content="kosmgco">

    <link href="/theme/css/fonts.css" rel="stylesheet" />

    <link href="/theme/css/normalize.css" rel="stylesheet"/>
    <link href="/theme/css/skeleton.css" rel="stylesheet"/>
    <link href="/theme/css/github-prettify-theme.css" rel="stylesheet"/>
    <link href="/theme/css/custom.css" rel="stylesheet"/>
    <link href="/theme/css/pygement.css" rel="stylesheet"/>

    <script src="/theme/js/jquery.min.js"></script>
    <script src="/theme/js/run_prettify.js"></script>
    <script src="/theme/js/site.js"></script>
</head>
<body class="code-snippets-visible">

<div class="navbar-spacer"></div>
<nav class="navbar">
    <div class="container">
        <ul class="navbar-list">
            <li class="navbar-item">
                <a class="navbar-link" href="/">
                    HOME
                </a>
            </li>
                <li class="navbar-item">
                    <a class="navbar-link" href="/pages/wiki.html">
                        wiki
                    </a>
                </li>
                <li class="navbar-item">
                    <a class="navbar-link" href="/pages/theme.html">
                        theme
                    </a>
                </li>
                <li class="navbar-item">
                    <a class="navbar-link" href="/pages/about.html">
                        about
                    </a>
                </li>
                <li class="navbar-item">
                    <a class="navbar-link" href="/pages/books.html">
                        books
                    </a>
                </li>
                <li class="navbar-item">
                    <a class="navbar-link" href="/pages/blog.html">
                        blog
                    </a>
                </li>
        </ul>
        <div class="navbar-link">
            <a href="/"><img src="/theme/images/avatar.jpg" class="site-icon"/></a>
        </div>
    </div>
</nav>
<div class="container">
    <section id="content">
        <article>
            <p class="article-date">
                2016-01-17 19:00:48+08:00
            </p>
            <header class="header">
                <a href="/pythonpa-qu-tu-pian.html" rel="bookmark" title="Permalink to python爬取图片">
                    <h2 class="blogpost-title">
                        python爬取图片
                    </h2>
                </a>
            </header>
            <div>
                <hr />
<p><img alt="enter image description here" src="http://7xp11h.com1.z0.glb.clouddn.com/01%20%281%29.jpg" /></p>
<p>在每个学习网络爬虫或者说在想学习网络爬虫的人身上，都能找到邪恶的一面。比如某图，某社区上面的图片、种子等。</p>
<!-- more -->

<p>参考知乎<a href="https://www.zhihu.com/question/27621722">能利用爬虫技术做到哪些很酷很有趣很有用的事情？</a></p>
<p>那今天就明说了吧，今天的目标网址是<a href="http://www.meizitu.com/">妹子图</a></p>
<p>首先观察一下网址列表：
<a href="http://www.meizitu.com/a/5275.html">http://www.meizitu.com/a/5275.html</a>
<a href="http://www.meizitu.com/a/5274.html">http://www.meizitu.com/a/5274.html</a>
<a href="http://www.meizitu.com/a/5273.html">http://www.meizitu.com/a/5273.html</a>
...</p>
<p>妹子图对于每个妹子的帖子是按照数字来进行编号，那我们就可以通过遍历这个网址列表来对图片进行爬取</p>
<p>一个循环:</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://www.meizitu.com/a/</span><span class="si">%s</span><span class="s1">.html&#39;</span><span class="o">%</span><span class="n">i</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="k">continue</span>
</pre></div>


<p>现在网址有了，接下来就是获得网页数据了，给一个请求通用方法:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span> <span class="s1">&#39;url request error&#39;</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span>
</pre></div>


<p>以<a href="http://www.meizitu.com/a/5274.html">时间躲在被子里深呼吸 ，像冬天的候鸟</a>为例。</p>
<p>咯。得到了网页之后，这里就是我需要的东西了。你懂得→_→
<img alt="enter image description here" src="http://7xp11h.com1.z0.glb.clouddn.com/Screenshot%20from%202016-01-17%2019:16:29.png" /></p>
<p>但是在那么繁杂的网页中怎么得到呢？这里使用了在<code>python</code>下<code>html</code>的解析利器：<code>BeautifulSoup</code>。在<code>C#</code>中也有解析<code>html</code>很好的库：<code>HtmlAgilitypack</code>。</p>
<p>上代码：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">content</span><span class="p">,</span><span class="s1">&#39;html5lib&#39;</span><span class="p">)</span>
    <span class="n">div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;postContent&#39;</span><span class="p">})</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">div</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">urls</span>
</pre></div>


<p>地址都有了，接下来不用我说都知道要干什么了吧。当然是把图片保存到本地：</p>
<div class="highlight"><pre><span></span><span class="c1"># 保存之前先创建目录,根据网页的title保存</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="k">def</span> <span class="nf">creat_dir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># 保存图片到本地</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">urls</span><span class="p">):</span>
    <span class="n">create_dir</span><span class="p">(</span><span class="s1">&#39;picture/</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">title</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;picture/&#39;</span> <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
</pre></div>


<p>搞定手工。但是你以为这样就完了吗？然而并没有。</p>
<p>你就能忍受这个程序龟速的跑着吗？你就能忍受等了一晚上才保存下来寥寥可数的图片吗？</p>
<p>那么为了充分利用经过提速降费的<code>高速低价</code>的宽带(不知道会不会被查水表。。。)以及如此高配的电脑，怎么能不利用多核的优势呢？把程序改成多进程的怎么样？把程序改成异步的怎么样？</p>
<p>经过测试，妹子图有反爬措施，频繁的访问会出现安全狗的提示，不让你访问了。 好吧，那我们把下图片的步骤改成异步的吧，那样就不会被封了。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">Download</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">queue</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">save</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">sleep</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; 由于打开网页太快会被反爬,所以用这个控制访问频率    &#39;&#39;&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">crawl</span><span class="p">():</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Download</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">urls</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="n">queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">crawl</span><span class="p">()</span>
</pre></div>


<p><strong>以上不是完整代码</strong></p>
<p>等一个晚上之后再去看<code>picture</code>文件夹下面的图片吧</p>
<p>。。。</p>
<p>虽然下了那么多图片，但是我觉得怎么可能一张一张的全部看完，追求的不过是一种成就感而已。</p>
            </div>
            <div class="article-info">
                <hr/>
                <div class="article-info">
                    <span><b>Category: </b><a href="/category/python.html">python</a></span>
                    <br/>
                    <span><b>Publication Date: </b> Sun 17 January 2016 </span>
                    <br/>
                        <a class="label-default" href="/tag/python.html">python</a>
                        <a class="label-default" href="/tag/mei-zi-tu.html">妹子图</a>
                        <a class="label-default" href="/tag/multiprocessing.html">multiprocessing</a>
                    <br/>
                </div>
            </div>
        </article>
    </section>
        <br/><br/><br/><br/>
</div>

<footer class="footer">
    &copy <a href="/" >kosmgco</a>. 2016
    <br/>
    Powered by <a href="http://getpelican.com/">pelican</a>.
    Theme by <a href="http://github.com/liyuan-t/ops">ops</a>
    <br/>
</footer>
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?67d2b3355046511d3ad9eef9c65d2a41";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
    })();
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
var duoshuoQuery = {short_name:"liyuan-t"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
<!-- 多说公共JS代码 end -->
</script>
</body>
</html>